---
title: "text mining"
author: "Christina"
date: "11/29/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(tidytext)
library(tidyr)
library(dplyr)
library(stringr)
library(ggplot2)
library(gutenbergr)
library(wordcloud)
library(reshape2)
```

```{r}
jane <- gutenberg_download(1260)

tidy_books <-jane %>%
  mutate(
    linenumber = row_number(),
    chapter = cumsum(str_detect(text, 
                                regex("^chapter [\\divxlc]", 
                                      ignore_case = TRUE)))) %>%
  unnest_tokens(word, text)

#remove stop words
data("stop_words")

tidy_books<-tidy_books %>%
  anti_join(stop_words)

length(unique(tidy_books$chapter))
count(tidy_books, chapter)
#find the most common words
tidy_books %>%
  count(word, sort = TRUE)

#visualization of the most common words
tidy_books %>%
  count(word, sort = TRUE) %>%
  filter(n > 200) %>%
  mutate(word = reorder(word, n)) %>%
  ggplot(aes(n, word)) +
  geom_col() +
  labs(y = NULL)

tidy_jane<- tidy_books %>%
  anti_join(stop_words)
```

#Sentiment analysis with inner join

```{r}
nrc_joy<-get_sentiments("nrc") %>%
  filter(sentiment == "joy")

tidy_books %>%
  inner_join(nrc_joy) %>%
  count(word, sort = TRUE)
```

#using "bing"

```{r}
#calculate negative and positive sentiment
jane_sentiment<-tidy_books %>%
  inner_join(get_sentiments("bing")) %>%
  count(index = linenumber %/% 60, sentiment) %>%
  pivot_wider(names_from = sentiment, values_from = n, values_fill = 0) %>%
  mutate(sentiment = positive - negative)

#plot sentiment scores
ggplot(jane_sentiment,aes(index, sentiment,)) +
  geom_col(show.legend = FALSE) 
  
```

#comparing the three sentiment dictionaries

```{r}
afinn<-tidy_books %>%
  inner_join(get_sentiments("afinn")) %>%
  group_by(index = linenumber %/% 60) %>%
  summarise(sentiment = sum(value)) %>%
  mutate(method = "AFINN")

bing_and_nrc<-bind_rows(
  tidy_books %>%
    inner_join(get_sentiments("bing")) %>%
    mutate(method = "Bing at al."),
  tidy_books %>%
    inner_join(get_sentiments("nrc") %>%
                 filter(sentiment %in% c("positive","negative"))
               ) %>%
    mutate(method = "NRC")) %>%
  count(method, index = linenumber %/% 60, sentiment) %>%
  pivot_wider(names_from = sentiment,
              values_from = n,
              values_fill = 0) %>%
  mutate(sentiment = positive - negative)

#visualize
bind_rows(afinn,
          bing_and_nrc) %>%
  ggplot(aes(index, sentiment, fill = method)) +
  geom_col(show.legend = FALSE) +
  facet_wrap(~method, ncol = 1, scales = "free_y")

#Why the result for the NRC lexicon biased so high in sentiment compared to the Bing et al. result?
get_sentiments("nrc") %>%
  filter(sentiment %in% c("positive", "negative")) %>%
  count(sentiment)

get_sentiments("bing") %>%
  count(sentiment)
```
#Most common positive and negative words

```{r}
bing_word_counts<-tidy_books %>%
  inner_join(get_sentiments("bing")) %>%
  count(word, sentiment, sort = TRUE) %>%
  ungroup()

bing_word_counts

#visualization
bing_word_counts %>%
  group_by(sentiment) %>%
  slice_max(n, n = 10) %>%
  ungroup() %>%
  mutate(word = reorder(word, n)) %>%
  ggplot(aes(n, word, fill = sentiment)) +
  geom_col(show.legend = FALSE) +
  facet_wrap(~sentiment, scales = "free_y") +
  labs(x = "Contribution to sentiment",
       y = NULL)
```

#Wordclouds

```{r}
tidy_books %>%
  anti_join(stop_words) %>%
  count(word) %>%
  with(wordcloud(word, n, max.words = 100))

#in other functions
tidy_books %>%
  inner_join(get_sentiments("bing")) %>%
  count(word, sentiment, sort = TRUE) %>%
  acast(word ~ sentiment, value.var = "n", fill = 0) %>%
  comparison.cloud(colors = c("gray20", "gray80"),
                   max.words = 100)
```

#Looking at units beyond just words

```{r}
p_and_p_sentences<-tibble(text = janeeyre) %>%
  unnest_tokens(sentence, text, token = "sentences")
```

#Task three
```{r}

library(devtools)
devtools::install_github("Truenumbers/tnum/tnum")

#'tnum' package
library(knitr)
library(gutenbergr)
library(tidyverse)
library(tnum)

tnum.authorize("mssp1.bu.edu")
tnum.getDBPathList(taxonomy = "subject", levels = 1)
tnum.setSpace("test2")

jane_eyre<-gutenberg_download(gutenberg_id = 1260)  ## download Jane Eyre

jane_eyre_txt<-readLines("jane.txt")
source("Book2TN-v3-hw.R")

## not run: tnBooksFromLines(jane_eyre$text, "jane_eyre")

tnum.getDBPathList(taxonomy = "subject", levels = 2)

#Explore the TNs that contain Jane Eyre text
## use query to check TNs
q20<-tnum.query("jane_eyre# has *",max = 3)
df20<-tnum.objectsToDf(q20)

q24<-tnum.query("jane_eyre/heading# has *",max = 60)
df24<-tnum.objectsToDf(q24)

q11<-tnum.query("jane_eyre/heading:0011# has *")
df11<-tnum.objectsToDf(q11)
ord_ch1<-unlist(tnum.query("jane_eyre/heading:0011# has ordinal"))

ord_ch2<-unlist(tnum.query("jane_eyre/heading:0012# has ordinal"))

q25<-tnum.query("jane_eyre/heading:0012# has *")
df25<-tnum.objectsToDf(q25)

ch1_txt<-tnum.query("jane_eyre/section:0011/paragraph:0002/# has text", max = 30)
ch1_txt_df<-tnum.objectsToDf(ch1_txt)
ch1_txt_df$string.value

ch2_txt<-tnum.query("jane_eyre/section:0011/paragraph:0002/sentence:# has *", max = 30)
ch2_txt_df<-tnum.objectsToDf(ch2_txt)
ch2_txt_df$string.value

length(ch2_txt_df$string.value)

q11<-tnum.query("jane_eyre/section:0011/paragraph:0001/# has *", max = 30)
df11<-tnum.objectsToDf(q11)
```

#Sentimentr

```{r}
library(sentimentr)
bb<-jane_eyre$text[35:45]
ab<-sentiment(bb)
```



## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
summary(cars)
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
